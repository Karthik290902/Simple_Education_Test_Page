<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HKR-2311-081 Intro to Anatomy & Physiology 41175</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    .pdf-controls { display: flex; justify-content: center; margin-bottom: 10px; gap: 10px; }
    .pdf-controls button { padding: 5px 10px; cursor: pointer; }
    #pdf-page-num { margin: 0 5px; }
    #pdf-canvas { max-width: 100%; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="course-container">
    <!-- Top Section: Course Info and Back Button -->
    <div class="top-section">
      <button class="back-button" onclick="window.location.href='index.html'">
        &larr; Back
      </button>
      <h1>HKR-2311-081 Intro to Anatomy & Physiology 41175</h1>
      <p>
        This course focuses on the human anotomy in depth!
      </p>
    </div>

    <!-- Main Content: Side Panel and PDF Viewer -->
    <div class="main-content">
      <!-- Side Panel -->
      <div class="side-panel">
        <h3>Course Materials</h3>
        <ul>
          <li onclick="loadPdf('assets/pdfs/course5/doc1.pdf')">Lesson 1</li>
          <li onclick="loadPdf('assets/pdfs/course5/doc2.pdf')">Lesson 2</li>
        </ul>
      </div>

      <!-- PDF Viewer -->
      <div class="pdf-viewer">
        <!-- Replace iframe with PDF.js viewer -->
        <div class="pdf-controls">
          <button id="prev-page">Previous</button>
          <span>Page <span id="pdf-page-num">1</span> of <span id="pdf-page-count">1</span></span>
          <button id="next-page">Next</button>
          <button id="save-offline">Save Offline</button>
        </div>
        <canvas id="pdf-canvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    const pdfJSWorkerUrl = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
    (async function() {
      // Set up PDF.js worker with safe local cache check
      async function setupWorker() {
        try {
          // Always set default worker source first
          pdfjsLib.GlobalWorkerOptions.workerSrc = pdfJSWorkerUrl;
          
          // Try to get cached worker
          if (typeof median !== 'undefined' && median.offlineAppSync) {
            try {
              const cachedWorker = await median.offlineAppSync.getSavedResource({
                url: pdfJSWorkerUrl
              });
              console.log("Worker info retrieved:", cachedWorker);
              
              // Only use the cached worker if it's not a file:// URL
              if (cachedWorker && cachedWorker.url && !cachedWorker.url.startsWith('file://')) {
                console.log("Using cached worker from:", cachedWorker.url);
                pdfjsLib.GlobalWorkerOptions.workerSrc = cachedWorker.url;
              } else {
                console.log("Cached worker has invalid URL, using CDN version");
              }
            } catch (error) {
              console.log("Could not retrieve cached worker:", error);
            }
            
            // Try to cache the worker for future use
            try {
              console.log("Ensuring PDF worker is cached...");
              await median.offlineAppSync.cacheResource({
                url: pdfJSWorkerUrl,
                priority: 1,
                saveForUser: true,
              });
              console.log("PDF worker cached successfully");
            } catch (cacheError) {
              console.log("Failed to cache PDF worker:", cacheError);
            }
          }
        } catch (error) {
          console.error("Error setting up PDF.js worker:", error);
          // Fallback to CDN version if anything fails
          pdfjsLib.GlobalWorkerOptions.workerSrc = pdfJSWorkerUrl;
        }
      }
      
      // Setup worker before proceeding
      await setupWorker();
      
      let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null;
      let scale = 1.5, currentPdfPath = 'assets/pdfs/course5/doc1.pdf';
      const canvas = document.getElementById('pdf-canvas'), ctx = canvas.getContext('2d');
      
      function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
          const viewport = page.getViewport({scale});
          canvas.height = viewport.height; canvas.width = viewport.width;
          const renderContext = { canvasContext: ctx, viewport };
          page.render(renderContext).promise.then(function() {
            pageRendering = false;
            if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
          });
        });
        document.getElementById('pdf-page-num').textContent = num;
      }
      
      function queueRenderPage(num) { pageRendering ? pageNumPending = num : renderPage(num); }
      
      function onPrevPage() { if (pageNum > 1) { pageNum--; queueRenderPage(pageNum); } }
      
      function onNextPage() { if (pageNum < pdfDoc.numPages) { pageNum++; queueRenderPage(pageNum); } }
      
      // Function to load PDF
      async function loadPdf(pdfPath) {
        currentPdfPath = pdfPath; // Update current PDF path
        let pdf_url = pdfPath;
        const baseUrl = "https://simple-education-test-page-delta.vercel.app";
        
        try {
          console.log('Trying to get PDF from offline storage');
          // Try to get the PDF from offline app sync
          let response = await median.offlineAppSync.getSavedResource({
            url: new URL(pdfPath, baseUrl).href
          });
          console.log('Response from offline storage', response);
          
          // If successful, use the returned URL
          if (response && response.url) {
            pdf_url = response.url;
            console.log('Using cached PDF from offline storage');
          } else {
            throw new Error('No cached PDF found');
          }
        } catch (error) {
          // If median doesn't exist or any other error occurs, fallback to original URL
          console.log('Falling back to original PDF URL', error);
          pdf_url = new URL(pdfPath, baseUrl).href // Fallback to original URL with base URL (IMP to include base URL to avoid file:// protocol)
        }
        
        // Load the PDF using PDF.js
        pdfjsLib.getDocument(pdf_url).promise.then(function(newPdfDoc) {
          pdfDoc = newPdfDoc;
          document.getElementById('pdf-page-count').textContent = pdfDoc.numPages;
          
          // Initial render
          pageNum = 1;
          renderPage(pageNum);
        });
      }
      window.loadPdf = loadPdf;
      
      // Function to save PDF for offline use
      async function savePdfOffline() {
        try {
          const pageTitle = document.title; // Get the current page title
          
          // Show saving indicator
          const saveButton = document.getElementById('save-offline');
          const originalText = saveButton.textContent;
          saveButton.textContent = 'Saving...';
          saveButton.disabled = true;
          
          // Cache the course page
          let responsePage = await median.offlineAppSync.cachePage({
            url: 'https://simple-education-test-page-delta.vercel.app/course5.html',
            priority: 1,
            name: pageTitle,
            saveForUser: true,
          });
          
          // Cache the current PDF
          let responsePdf = await median.offlineAppSync.cacheResource({
            url: "https://simple-education-test-page-delta.vercel.app/" + currentPdfPath,
            priority: 1,
            saveForUser: true,
          });
          
          // Update button to show success
          saveButton.textContent = 'Saved!';
          
          // Restore button after 2 seconds
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
          
          console.log('Page and PDF saved for offline use', responsePage, responsePdf);
        } catch (error) {
          console.error('Failed to save for offline use', error);
          document.getElementById('save-offline').textContent = 'Save Failed';
          
          // Restore button after 2 seconds
          setTimeout(() => {
            document.getElementById('save-offline').textContent = 'Save Offline';
            document.getElementById('save-offline').disabled = false;
          }, 2000);
        }
      }
      
      document.getElementById('prev-page').addEventListener('click', onPrevPage);
      document.getElementById('next-page').addEventListener('click', onNextPage);
      document.getElementById('save-offline').addEventListener('click', savePdfOffline);
      loadPdf('assets/pdfs/course5/doc1.pdf');
    })();
  </script>
</body>
</html>